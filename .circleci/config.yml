version: 2.1

jobs:
  build-cuttlefish:
    parameters:
      arch:
        type: enum
        enum: ["amd64", "arm64"]
      resource_class:
        type: string
    environment:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    machine:
      image: ubuntu-2204:current
      resource_class: << parameters.resource_class >>
    steps:
      - checkout
      - run:
          name: Configure git for HTTPS
          command: |
            git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
            git config --global url."https://github.com/".insteadOf "git@github.com:"
      - run:
          name: Install dependencies
          command: |
            sudo DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=a apt-get update
            sudo DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=a apt-get -y full-upgrade
            sudo DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=a apt-get install -y git devscripts equivs config-package-dev debhelper-compat golang curl zip
      - run:
          name: Clone android-cuttlefish
          command: git clone https://github.com/google/android-cuttlefish
      - when:
          condition:
            equal: [amd64, << parameters.arch >>]
          steps:
            - run:
                name: Install bazel (amd64)
                command: |
                  cd android-cuttlefish
                  sudo DEBIAN_FRONTEND=noninteractive tools/buildutils/installbazel.sh
      - run:
          name: Build packages
          command: |
            cd android-cuttlefish
            DEBIAN_FRONTEND=noninteractive CARGO_NET_GIT_FETCH_WITH_CLI=true tools/buildutils/build_packages.sh
      - run:
          name: Package debs
          command: |
            set -euo pipefail
            mkdir -p dist
            mapfile -d '' debs < <(find android-cuttlefish -name '*.deb' -type f -print0)
            if [ ${#debs[@]} -eq 0 ]; then
              echo "No .deb packages found." >&2
              exit 1
            fi
            zip -j dist/cuttlefish-<< parameters.arch >>.zip "${debs[@]}"
      - persist_to_workspace:
          root: .
          paths:
            - dist/cuttlefish-<< parameters.arch >>.zip

  release:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install gh CLI
          command: |
            sudo DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=a apt-get update
            sudo DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=a apt-get install -y gh
      - run:
          name: Publish release
          command: |
            set -euo pipefail
            if [ -z "${GH_TOKEN:-}" ]; then
              echo "GH_TOKEN is required to publish releases." >&2
              exit 1
            fi
            if [ ! -f dist/cuttlefish-amd64.zip ] || [ ! -f dist/cuttlefish-arm64.zip ]; then
              echo "Missing build artifacts." >&2
              ls -la dist || true
              exit 1
            fi
            tag="cuttlefish-$(date -u +%Y%m%d%H%M%S)"
            # gh CLI authenticates using GH_TOKEN from the environment.
            gh release create "$tag" dist/*.zip --title "Cuttlefish build $tag" --notes "Automated build."

workflows:
  build-and-release:
    jobs:
      - build-cuttlefish:
          name: build-amd64
          arch: amd64
          resource_class: medium
      - build-cuttlefish:
          name: build-arm64
          arch: arm64
          resource_class: arm.medium
      - release:
          requires:
            - build-amd64
            - build-arm64
          filters:
            branches:
              only:
                - main
  scheduled-build-and-release:
    triggers:
      - schedule:
          cron: "0 3 * * *" # Daily at 03:00 UTC.
          filters:
            branches:
              only:
                - main
    jobs:
      - build-cuttlefish:
          name: build-amd64
          arch: amd64
          resource_class: medium
      - build-cuttlefish:
          name: build-arm64
          arch: arm64
          resource_class: arm.medium
      - release:
          requires:
            - build-amd64
            - build-arm64
          filters:
            branches:
              only:
                - main
